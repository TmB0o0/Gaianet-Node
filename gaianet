#!/bin/bash

set -e  # Останавливаем скрипт при ошибке

WHITE='\e[97m'
TEAL='\e[36m'
RESET='\e[0m'

# Логотип
echo "  ##  ###  #######  ######   #######  #######  #######  ######   #######  ##  ##   #######  ###### "
echo "  ### ###  ##   ##  ##  ##   ##       ##         ###    ##  ##     ###    ##  ##   ##       ##  ## "
echo "  #######  ##   ##  ##  ##   ##       #######    ###    ##  ##     ###    ## ##    ##       ##  ## "
echo "  ## ####  ##  ###  ### ###  #######       ##    ###    #######    ###    #######  #######  ####### "
echo "  ##  ###  ##  ###  ### ###  ###      ###  ##    ###    ### ###    ###    ##  ###  ###      ### ### "
echo "  ##  ###  ##  ###  ### ###  # #      ###  ##    ###    ### ###    ###    ##  ###  # #      ### ### "
echo "  ##  ###  #######  #######  #######  #######    ###    ### ###  #######  ##  ###  #######  ### ### "

# Главное меню
echo -e "\n${WHITE}╔═══════════════════════════════╗${RESET}"
echo -e "${WHITE}║        МЕНЮ УПРАВЛЕНИЯ         ║${RESET}"
echo -e "${WHITE}╚═══════════════════════════════╝${RESET}\n"

echo -e "${TEAL}[1]${RESET} ➜ Установка ноды"
echo -e "${TEAL}[7]${RESET} ➜ Удаление ноды"
echo -e "${TEAL}[8]${RESET} ➜ Обновление домена ноды\n"

# Функция установки ноды
install_node() {
    echo "Updating system and installing required packages..."
    sudo apt update -y && sudo apt upgrade -y && sudo apt install screen pciutils -y

    echo "Installing GaiaNet..."
    curl -sSfL 'https://github.com/GaiaNet-AI/gaianet-node/releases/latest/download/install.sh' | bash

    source /root/.bashrc

    echo "Configuring GaiaNet..."
    gaianet config --port 8045

    echo "Initializing GaiaNet..."
    gaianet init

    echo "Starting GaiaNet..."
    gaianet start

    echo "Retrieving GaiaNet info..."
    gaianet info

    echo "GaiaNet setup completed successfully!"
}

# Функция удаления ноды
remove_node() {
    echo "Stopping GaiaNet..."
    gaianet stop
    
    echo "Removing GaiaNet base directory..."
    rm -rf "$HOME/gaianet"
    
    echo "Removing GaiaNet binary..."
    sudo rm -f /usr/local/bin/gaianet
    
    echo "Uninstalling WasmEdge..."
    bash <(curl -sSf https://raw.githubusercontent.com/WasmEdge/WasmEdge/master/utils/uninstall.sh) -q
    
    echo "Cleaning up environment variables..."
    sed -i '/export PATH="$HOME\/gaianet\/bin:\$PATH"/d' ~/.bashrc ~/.zshrc ~/.bash_profile ~/.zprofile
    
    echo "Node has been successfully removed. Please restart your shell session."
}

# Функция обновления домена ноды
update_domain() {
    echo -n "Введите новый домен: "
    read new_domain
    gaianet config --domain "$new_domain"
    echo "Домен ноды обновлен до $new_domain"
}

# Обработчик выбора пользователя
echo -n "Выберите действие: "
read choice

case $choice in
    1) install_node ;;
    7) remove_node ;;
    8) update_domain ;;
    *) echo "Неверный выбор, попробуйте снова." ;;
esac
